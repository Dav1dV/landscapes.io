{
    "AWSTemplateFormatVersion" : "2010-09-09",
    "Description" : "Master, or root, template for Reference Implementation",

    "Parameters" : {
        "ChefRepoGitAddress": {
            "Description": "The Git URL of chef repo to clone and upload to the chef server in the form https://user@github.com/path/chef.git",
            "Type": "String",
            "MinLength": "1",
            "Default": "https://aheifetz007@bitbucket.org/openwhere/uc-chef.git"
        },
        "ChefRepoGitPassword": {
            "Description": "The Git Password",
            "Type": "String",
            "MinLength": "1",
            "NoEcho": "true"
        },
        "VpcNetworkPrefix": {
            "Description": "First two octets of the IP address space",
            "Type": "String",
            "MinLength": "5",
            "MaxLength": "5",
            "Default": "10.22",
            "ConstraintDescription": "must be a valid first two octets ie 10.22"
        },"LocalIP": {
            "Description": "IP address for Firewall access",
            "Type": "String",
            "Default": "216.54.166.199"
        }
    },
    "Mappings": {
        "VPCAvailabilityZone1": {
            "us-east-1": {
                "Zone": "us-east-1a"
            },
            "us-west-2": {
                "Zone": "us-west-2b"
            },
            "us-west-1": {
                "Zone": "us-west-1a"
            },
            "eu-west-1": {
                "Zone": "eu-west-1a"
            },
            "ap-southeast-1": {
                "Zone": "ap-southeast-1a"
            },
            "ap-southeast-2": {
                "Zone": "ap-southeast-2a"
            },
            "ap-northeast-1": {
                "Zone": "ap-northeast-1a"
            },
            "sa-east-1": {
                "Zone": "sa-east-1a"
            }
        },
        "VPCAvailabilityZone2": {
            "us-east-1": {
                "Zone": "us-east-1b"
            },
            "us-west-2": {
                "Zone": "us-west-2c"
            },
            "us-west-1": {
                "Zone": "us-west-1c"
            },
            "eu-west-1": {
                "Zone": "eu-west-1b"
            },
            "ap-southeast-1": {
                "Zone": "ap-southeast-1b"
            },
            "ap-southeast-2": {
                "Zone": "ap-southeast-2b"
            },
            "ap-northeast-1": {
                "Zone": "ap-northeast-1c"
            },
            "sa-east-1": {
                "Zone": "sa-east-1b"
            }
        },
        "KeyNameMap": {
            "us-east-1": {
                "KeyName": "ah-test"
            },
            "us-west-2": {
                "KeyName": "ah-west-2"
            },
            "us-west-1": {
                "KeyName": "ah-west-1"
            },
            "eu-west-1": {
                "KeyName": "ah-eu-west-1"
            },
            "ap-southeast-1": {
                "KeyName": "ah-se-1"
            },
            "ap-southeast-2": {
                "KeyName": "ah-se-2"
            },
            "ap-northeast-1": {
                "KeyName": "ah-ne-1"
            },
            "sa-east-1": {
                "KeyName": "ah-sa-east-1"
            }
        }
    },


    "Resources" : {


        "VPC" : {
            "Type" : "AWS::CloudFormation::Stack",
            "Properties" : {
                "TemplateURL" : "https://s3.amazonaws.com/devops.openwhere.com/cf/vpc-complex.json",
                "Parameters" : {
                    "NetworkName" : { "Ref" : "AWS::StackName"},
                    "NatKeyName" : {"Fn::FindInMap": ["KeyNameMap", {"Ref": "AWS::Region"}, "KeyName"]},
                    "VpcNetworkPrefix" : { "Ref" : "VpcNetworkPrefix"},
                    "VPCAvailabilityZone1" : {"Fn::FindInMap": ["VPCAvailabilityZone1", {"Ref": "AWS::Region"}, "Zone"]},
                    "VPCAvailabilityZone2" : {"Fn::FindInMap": ["VPCAvailabilityZone2", {"Ref": "AWS::Region"}, "Zone"]}
                }
            }
        },
        "DemoSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupDescription": "Enable  access to the Chef Server",
                "VpcId": { "Fn::GetAtt" : [ "VPC", "Outputs.VpcId" ] },
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "-1",
                        "FromPort": "0",
                        "ToPort": "65535",
                        "CidrIp": "216.54.166.199/32"
                    }
                ],
                "SecurityGroupEgress": [
                    {
                        "IpProtocol": "-1",
                        "FromPort": "0",
                        "ToPort": "65535",
                        "CidrIp": "216.54.166.199/32"
                    }
                ]
            }
        },

        "ChefServer" : {
            "Type" : "AWS::CloudFormation::Stack",
            "Properties" : {
                "TemplateURL" : "https://s3.amazonaws.com/devops.openwhere.com/cf/chef-server.json",
                "Parameters" : {
                    "DomainName" : 	{"Fn::Join": [".", [{"Ref": "AWS::StackName"},"openwheredemo.com"] ]},
                    "VpcId" : 	{ "Fn::GetAtt" : [ "VPC", "Outputs.VpcId" ] },
                    "VpcNetworkPrefix" : { "Ref" : "VpcNetworkPrefix"},
                    "KeyName" : 	{"Fn::FindInMap": ["KeyNameMap", {"Ref": "AWS::Region"}, "KeyName"]},
                    "MgmtSubnet1" : { "Fn::GetAtt" : [ "VPC", "Outputs.MgmtStaticSubnet1Id" ] },
                    "ChefRepoGitAddress" : { "Ref" : "ChefRepoGitAddress"},
                    "ChefRepoGitPassword" : { "Ref" : "ChefRepoGitPassword"},
                    "SSHSecGroup" : { "Ref" : "DemoSecurityGroup"}
                }
            }
        }
    },
    "Outputs": {
"ChefExternalDNS": {
"Description": "The Chef Server External DNS Name",
"Value": { "Fn::GetAtt" : [ "ChefServer", "Outputs.ChefExternalDNS" ] }
}
}
}